<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS Variables for Material You Colors */
        :root {
            --card-bg: #FFFFFF; /* Pure white for cards */
            --accent-blue-dark: #4285F4; /* Google Blue, for primary actions, main icons */
            --accent-blue-light: #E8F0FE; /* Light blue for subtle backgrounds (e.g., info boxes, shortcut buttons) */
            --text-dark: #202124; /* Darkest gray for main headings/text */
            --text-medium: #5F6368; /* Medium gray for general text */
            --text-light: #80868B; /* Light gray for placeholders/less prominent text */
            --red-accent: #EA4335; /* Google Red, for second hand */
            --yellow-accent: #FACC15; /* Yellow for weather icon */
            --green-accent: #34A853; /* Google Green for new gradient */
            --button-cancel-bg: #E0E0E0; /* Consistent color for cancel buttons */
            --button-cancel-hover: #CDCDCD; /* Hover for cancel buttons */
        }

        /* Custom styles for the Inter font and overall body */
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://i.ibb.co/B28xXJ35/pexels-marek-piwnicki-3907296-11829357.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto; /* Allow vertical scrolling */
        }
        
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            cursor: pointer;
        }

        /* --- CLOCK DESIGN START: Updated based on image --- */
        .clock-hand {
            position: absolute;
            transform-origin: bottom center; /* Rotate from the bottom of the hand */
            left: 50%;
            transform: translateX(-50%); /* Center the hand horizontally */
        }

        .hour-hand {
            width: 6px;
            height: 40px; /* Shorter */
            top: calc(50% - 40px); /* Position from the center upwards */
            background-color: #FFFFFF; /* Hand color is white for dark background */
            border-radius: 9999px; /* Rounded ends */
            transition: transform 0.5s ease-out; /* Smoother transition */
        }

        .minute-hand {
            width: 6px;
            height: 60px; /* Medium length */
            top: calc(50% - 60px); /* Position from the center upwards */
            background-color: #FFFFFF; /* Hand color is white for dark background */
            border-radius: 9999px; /* Rounded ends */
            transition: transform 0.5s ease-out; /* Smoother transition */
        }

        .second-hand {
            width: 2px;
            height: 60px; /* Length of main part of the hand */
            top: calc(50% - 60px); /* Position from the center upwards */
            background-color: var(--red-accent);
            transition: transform 0.2s linear; /* Slightly smoother tick */
            border-radius: 0; /* Straight hand */
        }
        
        /* Tail for the second hand to match the new design */
        .second-hand::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 20px; /* Length of the tail */
            background-color: var(--red-accent);
            bottom: -20px; /* Position it below the main element */
            left: 0;
        }
        /* --- CLOCK DESIGN END --- */

        /* Specific styling for the main content area to ensure it's centered and responsive */
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%; /* Responsive width */
            max-width: 1200px; /* Max width for larger screens */
            padding: 20px;
            box-sizing: border-box;
        }

        /* Styling for the search input and button */
        .search-input-field {
            padding-right: 48px; /* Make space for the button */
        }

        /* Modal specific styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000; /* Ensure modals are on top */
        }

        .modal-content {
            max-height: 80vh; /* Limit modal height */
            overflow-y: auto; /* Enable scrolling within modal */
        }

        /* Favicon styling */
        .favicon-img {
            width: 16px; /* Standard favicon size */
            height: 16px;
            margin-right: 8px;
            border-radius: 2px; /* Slight rounding for favicons */
            flex-shrink: 0; /* Prevent image from shrinking */
        }

        /* Gradient Text Animation */
        .gradient-text {
            background: linear-gradient(90deg, #4285F4, #EA4335, #4285F4);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Style for the animated gradient button */
        .animated-gradient-btn {
            background: linear-gradient(90deg, #4285F4, #357AE8, #89b3ff, #4285F4);
            background-size: 300% 300%;
            animation: gradientShift 6s ease infinite;
            transition: transform 0.3s ease-in-out;
        }

        .animated-gradient-btn:hover {
            transform: scale(1.15); /* Slightly increased hover effect */
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="main-content space-y-6">
        <!-- Google Logo -->
        <div class="flex justify-center pb-4">
            <img src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_light_color_272x92dp.png" alt="Google Logo" class="h-16" style="filter: brightness(1.2);">
        </div>

        <!-- Top Section: Clock & Weather -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
            <!-- Clock Card -->
            <div class="p-6 rounded-3xl shadow-lg flex flex-col items-center justify-center col-span-1 md:col-span-1 relative min-h-[200px] bg-[linear-gradient(to_bottom_right,black_70%,#581c87)]">
                <div class="relative w-32 h-32 md:w-40 md:h-40 rounded-full flex items-center justify-center mb-4 bg-white/10">
                    <!-- Clock Face Center Dot -->
                    <div class="absolute w-3 h-3 rounded-full" style="background-color: var(--red-accent); z-index: 10;"></div>
                    <!-- Hour Hand -->
                    <div id="hourHand" class="clock-hand hour-hand"></div>
                    <!-- Minute Hand -->
                    <div id="minuteHand" class="clock-hand minute-hand"></div>
                    <!-- Second Hand -->
                    <div id="secondHand" class="clock-hand second-hand"></div>
                </div>
                <div class="text-center">
                    <p class="text-lg md:text-xl font-semibold mb-1 text-gray-100">
                        <span id="greetingText" class="gradient-text">Hello, <span id="userName">User</span>!</span>
                    </p>
                    <p id="currentDate" class="text-sm md:text-base text-gray-300"></p>
                </div>
            </div>

            <!-- Weather Card -->
            <div class="p-4 rounded-3xl shadow-lg col-span-1 md:col-span-2 flex flex-col justify-between min-h-[200px] bg-[linear-gradient(to_bottom_right,black_70%,#581c87)]">
                <div class="flex items-center justify-between mb-4">
                    <p id="weatherCondition" class="text-lg md:text-xl font-semibold text-gray-300">Weather data unavailable</p>
                    <div class="text-4xl md:text-5xl font-bold flex items-center text-white">
                        <span id="temperature">--</span>Â°
                        <svg id="weatherIcon" class="w-10 h-10 md:w-12 md:h-12 ml-2" fill="currentColor" viewBox="0 0 24 24" style="color: var(--yellow-accent);">
                            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.73 2.92-7 6.63C2.23 11.55 1 13.19 1 15c0 2.76 2.24 5 5 5h13c2.76 0 5-2.24 5-5 0-2.64-2.07-4.81-4.65-4.96z"/>
                        </svg>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm md:text-base mb-4 text-gray-300">
                    <div class="p-3 rounded-xl flex items-center justify-between bg-white/10">
                        <span>Chance of Rain</span>
                        <span id="chanceOfRain">--%</span>
                    </div>
                    <div class="p-3 rounded-xl flex items-center justify-between bg-white/10">
                        <span>Wind Speed</span>
                        <span id="windSpeed">-- m/s</span>
                    </div>
                </div>
                <div class="flex items-center justify-between text-sm md:text-base text-gray-300">
                    <div id="locationContainer" class="flex items-center cursor-pointer group">
                        <svg class="w-5 h-5 mr-1 transition-colors group-hover:text-white" fill="currentColor" viewBox="0 0 24 24" style="color: #a78bfa;">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                        <span id="location" class="transition-colors group-hover:text-white">Location</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="p-6 rounded-3xl shadow-lg w-full max-w-4xl bg-[linear-gradient(to_bottom_right,black_70%,#581c87)]">
            <div class="relative flex items-center mb-4">
                <!-- Google G logo -->
                <svg class="absolute left-3 w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#4285F4" d="M21.545 10.455H12v3.091h5.39a4.723 4.723 0 0 1-2.045 3.164v2.545h3.273c1.909-1.773 3.018-4.455 3.018-7.8z"/>
                    <path fill="#34A853" d="M12 22c2.727 0 5-1.227 6.655-3.3l-3.273-2.545c-.909.618-2.045.982-3.382.982-2.618 0-4.818-1.773-5.618-4.145H3.078v2.636A9.956 9.956 0 0 0 12 22z"/>
                    <path fill="#FBBC05" d="M6.382 13.636a5.9 5.9 0 0 1 0-3.272V7.727H3.078a9.99 9.99 0 0 0 0 8.545l3.304-2.636z"/>
                    <path fill="#EA4335" d="M12 6.364c1.473 0 2.8.509 3.818 1.473l2.891-2.891C16.891 3.018 14.618 2 12 2A9.956 9.956 0 0 0 2.045 7.727l3.304 2.636C6.164 8.136 8.364 6.364 12 6.364z"/>
                </svg>
                <input type="text" id="searchQuery" placeholder="Search Google..." class="w-full pl-10 pr-14 py-3 rounded-full border-2 border-transparent focus:outline-none focus:ring-2 search-input-field bg-white/10 text-white placeholder-gray-400 focus:ring-purple-500">
                
                <button id="voiceSearchBtn" class="absolute top-1/2 -translate-y-1/2 right-2 w-10 h-10 rounded-full shadow-md transition-colors flex items-center justify-center bg-white hover:bg-gray-100" aria-label="Voice Search">
                    <!-- Google Microphone Icon -->
                    <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <g>
                            <path id="mic-path-1" fill="#4285F4" d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3z"></path>
                            <path id="mic-path-2" fill="#34A853" d="M17.3 12c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.41 2.72 6.23 6 6.72V22h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"></path>
                        </g>
                    </svg>
                </button>
            </div>
            <div class="flex items-center flex-wrap gap-3 text-gray-300">
                <div id="shortcutButtonsContainer" class="flex-grow flex flex-wrap gap-3">
                    <!-- Shortcut buttons will be rendered here dynamically -->
                </div>
                <button id="manageShortcutsBtn" class="w-10 h-10 rounded-full flex items-center justify-center text-white focus:outline-none animated-gradient-btn" aria-label="Manage Shortcuts">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals (Location, API Key, Shortcuts, User Name) -->
    <div id="locationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden modal">
        <div class="p-8 rounded-xl shadow-lg w-96 modal-content" style="background-color: var(--card-bg);">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-dark);">Change Location</h2>
            <input type="text" id="newLocationInput" placeholder="Enter city name" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2" style="border-color: var(--accent-blue-light); color: var(--text-dark); focus-ring-color: var(--accent-blue-dark);">
            <div class="flex justify-end space-x-4">
                <button id="cancelLocationBtn" class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--button-cancel-bg); color: var(--text-dark); hover:background-color: var(--button-cancel-hover);">Cancel</button>
                <button id="saveLocationBtn" class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--accent-blue-dark); color: var(--card-bg); hover:background-color: #357AE8;">Save</button>
            </div>
        </div>
    </div>

    <div id="apiKeyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden modal">
        <div class="p-8 rounded-xl shadow-lg w-96 modal-content" style="background-color: var(--card-bg);">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-dark);">Enter OpenWeatherMap API Key</h2>
            <p class="text-sm mb-4" style="color: var(--text-medium);">To get live weather data, please enter your OpenWeatherMap API key. You can get one for free from <a href="https://openweathermap.org/api" target="_blank" class="hover:underline" style="color: var(--accent-blue-dark);">openweathermap.org/api</a>.</p>
            <input type="text" id="weatherApiKeyInput" placeholder="Your API Key" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2" style="border-color: var(--accent-blue-light); color: var(--text-dark); focus-ring-color: var(--accent-blue-dark);">
            <div class="flex justify-end space-x-4">
                <button id="cancelApiKeyBtn" class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--button-cancel-bg); color: var(--text-dark); hover:background-color: var(--button-cancel-hover);">Cancel</button>
                <button id="saveApiKeyBtn" class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--accent-blue-dark); color: var(--card-bg); hover:background-color: #357AE8;">Save</button>
            </div>
        </div>
    </div>

    <div id="manageShortcutsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden modal">
        <div class="p-8 rounded-xl shadow-lg w-full max-w-md modal-content" style="background-color: var(--card-bg);">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-dark);">Manage Shortcuts</h2>
            <div id="currentShortcutsList" class="mb-6 space-y-3"></div>
            <h3 class="text-lg font-semibold mb-3" style="color: var(--text-dark);">Add New Shortcut</h3>
            <input type="text" id="newShortcutName" placeholder="Name (e.g., Gmail)" class="w-full px-4 py-2 border rounded-lg mb-2 focus:outline-none focus:ring-2" style="border-color: var(--accent-blue-light); color: var(--text-dark); focus-ring-color: var(--accent-blue-dark);">
            <input type="url" id="newShortcutUrl" placeholder="URL (e.g., https://mail.google.com)" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2" style="border-color: var(--accent-blue-light); color: var(--text-dark); focus-ring-color: var(--accent-blue-dark);">
            <div class="flex justify-end space-x-4">
                <button id="addShortcutBtn" class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--accent-blue-dark); color: var(--card-bg); hover:background-color: #357AE8;">Add</button>
                <button id="closeShortcutsModalBtn" class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--button-cancel-bg); color: var(--text-dark); hover:background-color: var(--button-cancel-hover);">Close</button>
            </div>
        </div>
    </div>

    <div id="userNameModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden modal">
        <div class="p-8 rounded-xl shadow-lg w-96 modal-content" style="background-color: var(--card-bg);">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--text-dark);">Welcome!</h2>
            <p class="text-base mb-4" style="color: var(--text-medium);">What should I call you?</p>
            <input type="text" id="userNameInput" placeholder="Your Name" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2" style="border-color: var(--accent-blue-light); color: var(--text-dark); focus-ring-color: var(--accent-blue-dark);">
            <div class="flex justify-end">
                <button id="saveUserNameBtn" class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--accent-blue-dark); color: var(--card-bg); hover:background-color: #357AE8;">Save</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const hourHand = document.getElementById('hourHand');
            const minuteHand = document.getElementById('minuteHand');
            const secondHand = document.getElementById('secondHand');
            const currentDateElem = document.getElementById('currentDate');
            const userNameSpan = document.getElementById('userName');
            
            const temperatureElem = document.getElementById('temperature');
            const chanceOfRainElem = document.getElementById('chanceOfRain');
            const windSpeedElem = document.getElementById('windSpeed');
            const weatherConditionElem = document.getElementById('weatherCondition');
            const weatherIconElem = document.getElementById('weatherIcon');
            const locationElem = document.getElementById('location');
            const locationContainer = document.getElementById('locationContainer');

            const locationModal = document.getElementById('locationModal');
            const newLocationInput = document.getElementById('newLocationInput');
            const saveLocationBtn = document.getElementById('saveLocationBtn');
            const cancelLocationBtn = document.getElementById('cancelLocationBtn');

            const apiKeyModal = document.getElementById('apiKeyModal');
            const weatherApiKeyInput = document.getElementById('weatherApiKeyInput');
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
            const cancelApiKeyBtn = document.getElementById('cancelApiKeyBtn');
            
            const searchQueryInput = document.getElementById('searchQuery');
            const voiceSearchBtn = document.getElementById('voiceSearchBtn');

            const shortcutButtonsContainer = document.getElementById('shortcutButtonsContainer');
            const manageShortcutsBtn = document.getElementById('manageShortcutsBtn');
            const manageShortcutsModal = document.getElementById('manageShortcutsModal');
            const currentShortcutsList = document.getElementById('currentShortcutsList');
            const newShortcutNameInput = document.getElementById('newShortcutName');
            const newShortcutUrlInput = document.getElementById('newShortcutUrl');
            const addShortcutBtn = document.getElementById('addShortcutBtn');
            const closeShortcutsModalBtn = document.getElementById('closeShortcutsModalBtn');

            const userNameModal = document.getElementById('userNameModal');
            const userNameInput = document.getElementById('userNameInput');
            const saveUserNameBtn = document.getElementById('saveUserNameBtn');

            // --- State Variables ---
            let weatherApiKey = localStorage.getItem('weatherApiKey') || '';
            let userLocation = localStorage.getItem('userLocation') || 'New Delhi';
            let shortcuts = JSON.parse(localStorage.getItem('userShortcuts')) || [
                { name: 'Google', url: 'https://www.google.com/'},
                { name: 'YouTube', url: 'https://www.youtube.com/'},
                { name: 'GitHub', url: 'https://github.com/'},
                { name: 'Wikipedia', url: 'https://www.wikipedia.org/'}
            ];

            // --- Weather Icons ---
            const weatherConditions = {
                "Clear": { icon: `<path d="M12 5c-3.87 0-7 3.13-7 7s3.13 7 7 7 7-3.13 7-7-3.13-7-7-7zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>` },
                "Clouds": { icon: `<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.73 2.92-7 6.63C2.23 11.55 1 13.19 1 15c0 2.76 2.24 5 5 5h13c2.76 0 5-2.24 5-5 0-2.64-2.07-4.81-4.65-4.96z"/>` },
                "Rain": { icon: `<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.73 2.92-7 6.63C2.23 11.55 1 13.19 1 15c0 2.76 2.24 5 5 5h13c2.76 0 5-2.24 5-5 0-2.64-2.07-4.81-4.65-4.96zM7 18.28V18c0-2.21 1.79-4 4-4h1c.55 0 1 .45 1 1s-.45 1-1 1h-1c-1.1 0-2 .9-2 2v.28c-1.21.43-2 1.54-2 2.72 0 1.66 1.34 3 3 3s3-1.34 3-3c0-1.18-.79-2.29-2-2.72z"/>` },
                "Drizzle": { icon: `<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.73 2.92-7 6.63C2.23 11.55 1 13.19 1 15c0 2.76 2.24 5 5 5h13c2.76 0 5-2.24 5-5 0-2.64-2.07-4.81-4.65-4.96zM15 19l-3 3-3-3h2v-2h2v2h2z"/>` },
                "Thunderstorm": { icon: `<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.73 2.92-7 6.63C2.23 11.55 1 13.19 1 15c0 2.76 2.24 5 5 5h13c2.76 0 5-2.24 5-5 0-2.64-2.07-4.81-4.65-4.96zM14.5 17.5L11 21v-4H9l3.5-3.5L16 14v4h-1.5z"/>` },
                "Snow": { icon: `<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.73 2.92-7 6.63C2.23 11.55 1 13.19 1 15c0 2.76 2.24 5 5 5h13c2.76 0 5-2.24 5-5 0-2.64-2.07-4.81-4.65-4.96zM17 21c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM7 21c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>` },
                "Mist": { icon: `<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-3.72 0-6.73 2.92-7 6.63C2.23 11.55 1 13.19 1 15c0 2.76 2.24 5 5 5h13c2.76 0 5-2.24 5-5 0-2.64-2.07-4.81-4.65-4.96zM7 17h10v2H7zM7 13h10v2H7z"/>` }
            };

            // --- Functions ---
            
            // --- FIXED: updateClock function to prevent transition glitch ---
            function updateClock() {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();

                // This is the fix: when a hand resets to 0, we temporarily disable its transition
                // to prevent it from sweeping backward.
                if (seconds === 0) {
                    secondHand.style.transition = 'none';
                    minuteHand.style.transition = 'none';
                    hourHand.style.transition = 'none';
                } else {
                    // Re-apply the transitions for smooth movement during the rest of the time.
                    secondHand.style.transition = 'transform 0.2s linear';
                    minuteHand.style.transition = 'transform 0.5s ease-out';
                    hourHand.style.transition = 'transform 0.5s ease-out';
                }

                const hourDeg = (hours % 12) * 30 + 0.5 * minutes;
                const minuteDeg = minutes * 6 + 0.1 * seconds;
                const secondDeg = seconds * 6;

                hourHand.style.transform = `translateX(-50%) rotate(${hourDeg}deg)`;
                minuteHand.style.transform = `translateX(-50%) rotate(${minuteDeg}deg)`;
                secondHand.style.transform = `translateX(-50%) rotate(${secondDeg}deg)`;

                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                currentDateElem.textContent = now.toLocaleDateString('en-US', options);
            }

            async function fetchWeatherData(location) {
                locationElem.textContent = location;
                if (!weatherApiKey) {
                    updateMockWeatherData();
                    return;
                }
                try {
                    // Using the forecast endpoint to get the 'pop' (probability of precipitation)
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${location}&appid=${weatherApiKey}&units=metric`);
                    const data = await response.json();

                    if (data.cod === "200") {
                        const forecast = data.list[0];
                        temperatureElem.textContent = Math.round(forecast.main.temp);
                        chanceOfRainElem.textContent = `${Math.round(forecast.pop * 100)}%`;
                        windSpeedElem.textContent = `${forecast.wind.speed} m/s`;
                        weatherConditionElem.textContent = forecast.weather[0].description.charAt(0).toUpperCase() + forecast.weather[0].description.slice(1);
                        
                        const mainWeather = forecast.weather[0].main;
                        weatherIconElem.innerHTML = weatherConditions[mainWeather]?.icon || weatherConditions['Clouds'].icon;
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error("Error fetching weather data:", error);
                    updateMockWeatherData();
                    displayMessageBox(`Could not fetch weather for ${location}: ${error.message}. Displaying mock data.`);
                }
            }

            function updateMockWeatherData() {
                temperatureElem.textContent = '--';
                chanceOfRainElem.textContent = '--%';
                windSpeedElem.textContent = '-- m/s';
                weatherConditionElem.textContent = 'Weather data unavailable';
                weatherIconElem.innerHTML = weatherConditions['Clouds'].icon;
            }

            function performSearch(query = searchQueryInput.value.trim()) {
                if (query) {
                    const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    window.open(url, '_blank');
                }
            }
            
            function getFaviconUrl(url) {
                try {
                    const parsedUrl = new URL(url);
                    return `https://www.google.com/s2/favicons?domain=${parsedUrl.hostname}&sz=32`;
                } catch (e) {
                    return ''; // Return empty string for invalid URLs
                }
            }

            function saveShortcuts() {
                localStorage.setItem('userShortcuts', JSON.stringify(shortcuts));
            }

            function renderShortcutButtons() {
                shortcutButtonsContainer.innerHTML = '';
                shortcuts.forEach(shortcut => {
                    const button = document.createElement('button');
                    button.className = 'shortcut-btn px-4 py-2 rounded-full shadow-sm transition-colors text-sm md:text-base flex items-center';
                    // Updated for dark theme
                    button.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                    button.style.color = '#d1d5db'; // text-gray-300
                    button.onmouseover = () => button.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    button.onmouseout = () => button.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                    button.onclick = () => window.open(shortcut.url, '_blank');

                    const faviconUrl = getFaviconUrl(shortcut.url);
                    const img = document.createElement('img');
                    img.src = faviconUrl;
                    img.alt = '';
                    img.className = 'favicon-img';
                    img.onerror = () => img.style.display = 'none';

                    button.appendChild(img);
                    button.appendChild(document.createTextNode(shortcut.name));
                    shortcutButtonsContainer.appendChild(button);
                });
            }

            function renderManageShortcutsList() {
                currentShortcutsList.innerHTML = '';
                shortcuts.forEach((shortcut, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 rounded-lg';
                    div.style.backgroundColor = 'var(--accent-blue-light)';
                    
                    const faviconUrl = getFaviconUrl(shortcut.url);
                    const imgHtml = faviconUrl ? `<img src="${faviconUrl}" alt="" class="favicon-img" onerror="this.style.display='none';">` : '';

                    div.innerHTML = `
                        <div class="flex items-center">
                            ${imgHtml}
                            <span style="color: var(--text-medium);">${shortcut.name} (<a href="${shortcut.url}" target="_blank" class="hover:underline" style="color: var(--accent-blue-dark);">${shortcut.url}</a>)</span>
                        </div>
                        <button class="remove-shortcut-btn bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors" data-index="${index}" aria-label="Remove shortcut ${shortcut.name}">&times;</button>
                    `;
                    currentShortcutsList.appendChild(div);
                });
            }

            function displayMessageBox(message) {
                // Remove any existing message box first
                const existingModal = document.querySelector('.message-box-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center modal message-box-modal';
                messageBox.innerHTML = `
                    <div class="p-8 rounded-xl shadow-lg w-80 modal-content" style="background-color: var(--card-bg);">
                        <h2 class="text-xl font-semibold mb-4" style="color: var(--text-dark);">Notification</h2>
                        <p class="text-base mb-6" style="color: var(--text-medium);">${message}</p>
                        <div class="flex justify-end">
                            <button class="px-4 py-2 rounded-full transition-colors" style="background-color: var(--accent-blue-dark); color: var(--card-bg);" onclick="this.closest('.modal').remove()">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }

            // --- Event Listeners ---
            locationContainer.addEventListener('click', () => {
                newLocationInput.value = userLocation;
                locationModal.classList.remove('hidden');
            });

            saveLocationBtn.addEventListener('click', () => {
                const newLoc = newLocationInput.value.trim();
                if (newLoc) {
                    userLocation = newLoc;
                    localStorage.setItem('userLocation', userLocation);
                    fetchWeatherData(userLocation);
                    locationModal.classList.add('hidden');
                } else {
                    displayMessageBox("Please enter a city name.");
                }
            });

            cancelLocationBtn.addEventListener('click', () => locationModal.classList.add('hidden'));

            saveApiKeyBtn.addEventListener('click', () => {
                const newKey = weatherApiKeyInput.value.trim();
                weatherApiKey = newKey;
                localStorage.setItem('weatherApiKey', weatherApiKey);
                fetchWeatherData(userLocation);
                apiKeyModal.classList.add('hidden');
            });

            cancelApiKeyBtn.addEventListener('click', () => apiKeyModal.classList.add('hidden'));

            searchQueryInput.addEventListener('keypress', e => e.key === 'Enter' && performSearch());

            manageShortcutsBtn.addEventListener('click', () => {
                renderManageShortcutsList();
                manageShortcutsModal.classList.remove('hidden');
            });

            closeShortcutsModalBtn.addEventListener('click', () => manageShortcutsModal.classList.add('hidden'));

            addShortcutBtn.addEventListener('click', () => {
                const name = newShortcutNameInput.value.trim();
                const url = newShortcutUrlInput.value.trim();
                if (name && url) {
                    try {
                        new URL(url);
                        shortcuts.push({ name, url });
                        saveShortcuts();
                        renderShortcutButtons();
                        renderManageShortcutsList();
                        newShortcutNameInput.value = '';
                        newShortcutUrlInput.value = '';
                    } catch (e) {
                        displayMessageBox("Please enter a valid URL (e.g., https://example.com)");
                    }
                } else {
                    displayMessageBox("Please enter both a name and a URL.");
                }
            });
            
            currentShortcutsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-shortcut-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    shortcuts.splice(index, 1);
                    saveShortcuts();
                    renderShortcutButtons();
                    renderManageShortcutsList();
                }
            });

            saveUserNameBtn.addEventListener('click', () => {
                const newUserName = userNameInput.value.trim();
                if (newUserName) {
                    localStorage.setItem('userName', newUserName);
                    userNameSpan.textContent = newUserName;
                    userNameModal.classList.add('hidden');
                } else {
                    displayMessageBox("Please enter your name.");
                }
            });

            // --- Updated Voice Search ---
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                const micPath1 = document.getElementById('mic-path-1');
                const micPath2 = document.getElementById('mic-path-2');

                recognition.onstart = () => {
                    searchQueryInput.placeholder = "Listening...";
                    if(micPath1) micPath1.setAttribute('fill', '#EA4335');
                    if(micPath2) micPath2.setAttribute('fill', '#EA4335');
                    voiceSearchBtn.classList.add('animate-pulse');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    searchQueryInput.value = transcript;
                    // A small delay to let the user see the transcript before searching
                    setTimeout(() => {
                        performSearch(transcript);
                    }, 300);
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error);
                    let errorMessage = `Voice search error: ${event.error}.`;
                    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                        errorMessage = "Microphone access was denied. Please allow microphone access in your browser settings to use voice search.";
                    } else if (event.error === 'no-speech') {
                        errorMessage = "No speech was detected. Please try again.";
                    }
                    displayMessageBox(errorMessage);
                };

                recognition.onend = () => {
                    searchQueryInput.placeholder = "Search Google...";
                    if(micPath1) micPath1.setAttribute('fill', '#4285F4');
                    if(micPath2) micPath2.setAttribute('fill', '#34A853');
                    voiceSearchBtn.classList.remove('animate-pulse');
                };

                voiceSearchBtn.addEventListener('click', () => {
                    try {
                        recognition.start();
                    } catch (e) {
                        // This can happen if recognition is already started.
                        console.error("Could not start recognition:", e);
                    }
                });

            } else {
                voiceSearchBtn.style.display = 'none'; // Hide button if not supported
                console.log("Speech Recognition not supported.");
            }


            // --- Initial Setup ---
            function initialize() {
                // Clear search bar on load
                searchQueryInput.value = '';

                // Clock
                setInterval(updateClock, 1000);
                updateClock();

                // User Name
                const storedUserName = localStorage.getItem('userName');
                if (!storedUserName) {
                    userNameModal.classList.remove('hidden');
                } else {
                    userNameSpan.textContent = storedUserName;
                }

                // Weather
                if (!weatherApiKey) {
                    apiKeyModal.classList.remove('hidden');
                }
                fetchWeatherData(userLocation);

                // Shortcuts
                renderShortcutButtons();
            }

            initialize();
        });
    </script>
</body>
</html>
